name: Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build-desktop:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            runtime: linux-x64
          - os: windows-latest
            runtime: win-x64
          - os: macos-latest
            runtime: osx-x64
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET 10
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Restore dependencies
      run: dotnet restore

    - name: Build Core
      run: dotnet build src/PrismaAI.Core/PrismaAI.Core.csproj --configuration Release

    - name: Publish Desktop
      run: dotnet publish src/PrismaAI.UI/PrismaAI.UI.csproj -c Release -r ${{ matrix.runtime }} --self-contained -o publish/${{ matrix.runtime }}

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: PrismaAI-${{ matrix.runtime }}
        path: publish/${{ matrix.runtime }}

  build-android:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET 10
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'microsoft'
        java-version: '21'

    - name: Install Android SDK
      uses: android-actions/setup-android@v3

    - name: Install workload
      run: |
        dotnet workload install android
        dotnet workload install maui

    - name: Restore dependencies
      run: dotnet restore src/PrismaAI.UI/PrismaAI.UI.csproj

    - name: Build Android APK
      run: dotnet build src/PrismaAI.UI/PrismaAI.UI.csproj -c Release -f net10.0-android /p:AndroidPackageFormat=apk

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: PrismaAI-Android
        path: src/PrismaAI.UI/bin/Release/net10.0-android/publish/*.apk

  build-ios:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET 10
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Install workload
      run: |
        dotnet workload install ios
        dotnet workload install maui

    - name: Build iOS
      run: dotnet build src/PrismaAI.UI/PrismaAI.UI.csproj -c Release -f net10.0-ios

  release:
    needs: [build-desktop, build-android]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          PrismaAI-*/**/*
          PrismaAI-*/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
